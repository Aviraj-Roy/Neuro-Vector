# Changes Made on 2026-02-14

This document captures the backend changes implemented today for dashboard bill lifecycle and filtering support.

## 1. Bill Lifecycle: Active vs Deleted

### Data model fields added/standardized
- `is_deleted` (bool, default `false`)
- `deleted_at` (nullable datetime string)
- `deleted_by` (nullable string)
- `delete_mode` (nullable string, set to `"temporary"` for soft deletes)

Applied in:
- `backend/app/db/mongo_client.py`

Legacy compatibility:
- Missing `is_deleted` is treated as active (`false`) by API logic.

## 2. API Contract Updates

### `GET /bills`
Added query params:
- `scope=active|deleted` (default: `active`)
- `status=PENDING|PROCESSING|COMPLETED` (optional)
- `hospital_name` (optional, case-insensitive exact match)
- `date_filter=TODAY|YESTERDAY|THIS_MONTH|LAST_MONTH` (optional)

Behavior:
- `scope=active` returns non-deleted bills.
- `scope=deleted` returns deleted bills.
- Date filter uses `upload_date` with fallback `created_at`.
- Date window uses **server local timezone**.

### `GET /bills/deleted`
- Kept as convenience endpoint.
- Same optional filters (`status`, `hospital_name`, `date_filter`).
- Always returns deleted scope.

### `DELETE /bills/{bill_id}`
Added query param:
- `permanent` (default: `false`)

Behavior:
- `permanent=false`: soft delete
  - sets `is_deleted=true`, `deleted_at=now`, `delete_mode="temporary"`
- `permanent=true`: hard delete
  - allowed only if bill is already soft-deleted

### `POST /bills/{bill_id}/restore`
- Restores a soft-deleted bill to active:
  - `is_deleted=false`
  - `deleted_at=null`
  - `deleted_by=null`
  - `delete_mode=null`

## 3. Transition Safety Rules

Implemented explicit errors:
- Restore active bill -> `409 Conflict`
- Soft-delete already deleted bill -> `409 Conflict`
- Permanent delete active bill -> `409 Conflict`
- Permanent delete non-existent bill -> `404 Not Found`

## 4. Response Contract Alignment

List/detail responses now include fields needed by dashboard:
- `bill_id`
- `upload_id`
- `employee_id`
- `hospital_name`
- `status`
- `invoice_date`
- `upload_date`
- `created_at`
- `updated_at`
- `is_deleted`
- `deleted_at`

Primary file:
- `backend/app/api/routes.py`

## 5. Database Indexing

Added/updated indexes for dashboard query performance:
- `is_deleted`
- `status` (existing status index retained)
- `hospital_name_metadata`
- `upload_date`
- Compound: `is_deleted + upload_date(desc)`

File:
- `backend/app/db/init_indexes.py`

## 6. Migration Utility

Added script to backfill soft-delete fields on existing records:
- `backend/scripts/migrate_soft_delete_fields.py`

Backfills:
- `is_deleted` if missing
- `deleted_at` if missing
- `deleted_by` if missing
- `delete_mode` if missing

## 7. Tests Added/Updated

Updated test coverage for:
- scope-based listing (`active`, `deleted`)
- soft delete flow
- restore flow
- permanent delete flow
- combined filters with scope
- invalid transition edge cases

Primary test file:
- `backend/tests/test_delete_bill_api.py`

## 8. Quick Reference Update

Updated quick reference with new dashboard endpoints and examples:
- `QUICK_API_REFERENCE.md`

---

If needed, this can be split further into:
- `API_CHANGES_2026-02-14.md`
- `DB_CHANGES_2026-02-14.md`
- `TEST_CHANGES_2026-02-14.md`
